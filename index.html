<!DOCTYPE html>
<html>
  <head>
    <title>Self-Paced Reading</title>
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/jspsych.js"></script>
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/plugins/jspsych-html-button-response.js"></script>
    <link href="https://web-experiments.lab.hum.uu.nl/jspsych/6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"/>
    
    <!-- 'custom' plugin -->
    <script src="jspsych-moving-window.js"></script>


    <!-- Uil OTS scripts -->
    <script src="stimuli.js"></script>
    <script src="globals.js"></script>
    <script src="instructions.js"></script>
    <script src="generic.js"></script>

    <!-- custom styling: font -->
    <style>
    .stimulus { 
      font-size: 30px; 
      font-family: monospace, monospace;
    }
    </style>
  </head>
  <body></body>
  <script>
    //////////////// stimulus.js /////////////////////////////////
    
    var stimuli = select_random_group();
    console.log(stimuli)
    console.log(stimuli.table)

    // data one would like to add to __all__ trials, according to:
    // https://www.jspsych.org/overview/data/
    var subject_id = jsPsych.randomization.randomID(8);
    var group_assigned = stimuli.group_name;

    // record the condition assignment in the jsPsych data
    // this adds a property called 'subject' and a property called 'conditio' to every trial
    jsPsych.data.addProperties(
    {
      subject: subject_id,
      group: group_assigned,
      condition: jsPsych.timelineVariable('condition')
    });

    //////////////// test page flows ///////////////////////////////
    
    var start_screen = {
      type: 'html-button-response',
      stimulus: PRE_PRACTICE_INSTRUCTION, 
      choices: [OK_BUTTON_TEXT],
      response_ends_trial: true
    };
    
    var well_done_screen = {
      type: 'html-button-response',
      stimulus: POST_PRACTICE_INSTRUCTION, 
      choices: [OK_BUTTON_TEXT],
      response_ends_trial: true
    };

    var end_screen = {
      type: 'html-keyboard-response',
      stimulus: "Thanks, you're done. Press spacebar to see data", 
      choices: ['space']
    };

    var present_story = {
      type: 'moving-window',
      words: jsPsych.timelineVariable('words')
    }

    //Usually this is done with "vanilla" JS code, not jsPsych specific code. For example, you might define two sets of trials:
//     var a_trials = [, trial_2, trial_3];
//     var b_trials = [trial_4, trial_5, trial_6];

// Then use an if statement to push only the relevant trials onto the timeline.

// if(subjectID%2 == 0){
//   timeline = timeline.concat(a_trials);
// } else {
//   timeline = timeline.concat(b_trials);
// }


    var present_question_or_statement = {
    type: 'html-button-response',
    stimulus: jsPsych.timelineVariable('question_or_statement'),
    choices: jsPsych.timelineVariable('choices'),
    button_html: '<button class="jspsych-btn">%choice%</button>',
    prompt: "",
    trial_duration: 10000,
    data: {
      condition: jsPsych.timelineVariable('condition'),
      trial_part: 'present_question_or_statement',
      task_part: jsPsych.timelineVariable('part'),
      correct_response : jsPsych.timelineVariable('correct')
    },
    on_finish: function(data) {
        var acc = false;
        var used_button = data.button_pressed;
        var given_response = jsPsych.timelineVariable('choices')[used_button];

        if (data.correct_response == data.button_pressed) {
            acc = true;
        }

        data.accuracy = acc;
        //console.log(data.accuracy)
      },
    }; 

    var present_feedback = {
      type: 'html-keyboard-response',
      stimulus: function() {
        var feedback_text = '<span style="color:red;font-size:30px;">Incorrect.</span>'
        var last_resp_acc = jsPsych.data.getLastTrialData().values()[0].accuracy;
        if (last_resp_acc == true) {
            feedback_text = '<span style="color:green;font-size:30px;">Correct!</span>'
        }
        return feedback_text;
      },
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000
    };

    var practice_procedure = {
      timeline: [
        present_story, 
        present_question_or_statement,
        present_feedback
        ],
      timeline_variables: practice_items,
      randomize_order: false
    };

    // now, i'm unsure what will be best here....




    // var test_procedure_noextra = {
    //   timeline: conditional_timeline,
    //   timeline_variables: stimuli.table,
    //   randomize_order: false
    // };

    // var test_procedure_extra = {
    //   timeline: [present_story, present_question_or_statement],
    //   timeline_variables: stimuli.table,
    //   randomize_order: false
    // };



    // timeline
    var timeline = [];


    ////////////////////////////////////

            //generic/precalc?
    var p = PROPORTION_QUESTION_OR_STATEMENT;
    var n = stimuli.table.length
    
    console.log('n')
    console.log(n)

    var nonrandomArray = createBooleanArrayAfterPercentage(p, n);
    var shuffledArray = randomArrayShuffle(nonrandomArray);

    for (var i = 0; i < shuffledArray.length; i++) {
      if (i == true){
        sub_timeline = [present_story, present_question_or_statement]
      }
      else {
        sub_timeline = [present_story]
      }
    };

    var test_procedure = {
      timeline: sub_timeline,
      timeline_variables: stimuli.table,
      randomize_order: false
    };
    ///////////////////////////////////


    timeline.push(start_screen)
    // timeline.push(practice_procedure)
    // timeline.push(well_done_screen)
    timeline.push(test_procedure)


    timeline.push(end_screen)

    jsPsych.init({
      timeline: timeline,
      on_finish: function(){
        jsPsych.data.displayData()
      }
    })
  </script>
</html>
